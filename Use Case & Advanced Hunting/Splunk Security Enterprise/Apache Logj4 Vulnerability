##Linux Detections##
index=linux ("jndi:ldap:" OR "jndi:rmi:" OR "jndi:ldaps" OR "jndi:dns" ) referer!="*172.16.95.141*"|search NOT ("remoteAddress":"172.16.95.141")
| table _time host _raw
|rename host as dest


##WAF##
index=waf sourcetype="f5:bigip:asm:syslog"  action="passed" resp_code!="40*"
(((http_user_agent="*jndi*") (http_user_agent="*ldap*" OR http_user_agent="*rmi*" OR http_user_agent="*ldaps*" OR http_user_agent="*dns*" OR http_user_agent="*lower*" OR http_user_agent="*upper*"))
OR 
((uri="*jndi*") (uri="*ldap*" OR uri="*rmi*" OR uri="*ldaps*" OR uri="*dns*" OR uri="*lower*" OR uri="*upper*"))
OR
((headers="*jndi*") (headers="*ldap*" OR headers="*rmi*" OR headers="*ldaps*" OR headers="*dns*" OR headers="*lower*" OR headers="*upper*")))
| fillnull resp_code src_ip, dest_ip, dest_port action
| stats count values(http_user_agent) as http_user_agent values(uri) as uri values(headers) as headers by _time resp_code src_ip, dest_ip, dest_port action 
| sort -_time
| table _time action  resp_code src_ip dest_ip http_user_agent uri headers


##Windows Detection##
index=wineventlog sourcetype="XmlWinEventLog"EventCode=4688  (ParentProcessName=*log4j* OR NewProcessName=*log4j*)
| eval ProcessId = tonumber(ProcessId, 16)
| eval NewProcessId = tonumber(NewProcessId, 16)
|table _time action  dest  SubjectUserSid   ProcessId ParentProcessName NewProcessId NewProcessName CommandLine 
|sort -_time
|rename SubjectUserSid as user


##Firewall Detection##
index=firewall sourcetype="pan:threat" (signature_id=91991 OR  signature_id=91994 OR signature_id=91995)
| stats list(dest_ip) list(dest_port) list(src_port) list(url) list(_time) AS timestamp list(action) count by src 
| convert ctime(timestamp)


##Web Server Detection##
index=webserver sourcetype="ms:iis:auto" ("jndi:ldap:" OR "jndi:rmi:" OR "jndi:ldaps" OR "jndi:dns" ) c_ip!=172.16.95.141 c_ip!=172.20.48.30
| table _time c_ip s_ip host s_port sc_status cs_method cs_Referer cs_User_Agent cs_uri_stem 
| rename c_ip as src s_ip as dest_ip s_port as dest_port 
| stats list(src) as src list(dest_ip) as dest_ip list(dest_port) as dest_port list(_time) as timestamp list(cs_Referer) as Referer list(cs_User_Agent) as useragent list(cs_uri_stem) as uri_stem count by host cs_method 
| convert ctime(timestamp)
| rename host as dest
